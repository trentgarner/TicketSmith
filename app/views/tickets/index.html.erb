<%= turbo_frame_tag "tickets_view", data: { turbo_cache: false } do %>
  <% view = tickets_view %>
  <% filters = ticket_filters %>
  <% highlight_id = params[:highlight].to_i %>
  <% base_params = {
       view: view,
       filters: filters,
       page: params[:page],
       limit: params[:limit]
     } %>

  <% if turbo_frame_request? %>
    <% flash.each do |type, message| %>
      <% next if message.blank? %>
      <% bs_class =
        case type.to_sym
        when :notice then "success"
        when :alert then "danger"
        else "secondary"
        end %>
      <div class="alert alert-<%= bs_class %> alert-dismissible fade show" role="alert" data-controller="flash">
        <%= message %>
      </div>
    <% end %>
  <% end %>

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="mb-1">TicketSmith</h1>
      <p class="text-muted mb-0">Track issues and keep work moving.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group" role="group" aria-label="View toggle">
        <%= link_to tickets_path(view: "list"),
            class: "btn btn-outline-secondary #{view == "list" ? "active" : ""}",
            data: { turbo_frame: "tickets_view" },
            aria: { label: "List view" } do %>
          <span class="view-icon view-icon-list" aria-hidden="true"></span>
        <% end %>
        <%= link_to tickets_path(view: "board"),
            class: "btn btn-outline-secondary #{view == "board" ? "active" : ""}",
            data: { turbo_frame: "tickets_view" },
            aria: { label: "Board view" } do %>
          <span class="view-icon view-icon-board" aria-hidden="true"></span>
        <% end %>
      </div>
    <%= link_to "New Ticket", new_ticket_path(view: tickets_view), class: "btn btn-primary", data: { turbo_frame: "_top" } %>
  </div>
</div>

  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="fw-semibold">Filters</div>
        <div class="d-flex flex-wrap gap-2">
          <% if my_assignee.present? %>
            <%= link_to "My Tickets", tickets_path(base_params.merge(filters: filters.merge("assignee" => my_assignee))),
                  class: "btn btn-sm btn-outline-secondary",
                  data: { turbo_frame: "tickets_view" } %>
          <% else %>
            <%= link_to "Set My Tickets", edit_user_registration_path,
                  class: "btn btn-sm btn-outline-secondary",
                  data: { turbo_frame: "_top" } %>
          <% end %>
          <%= link_to "Clear Filter", tickets_path(base_params.merge(clear: 1)),
                class: "btn btn-sm btn-outline-secondary",
                data: { turbo_frame: "tickets_view" } %>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="small text-muted">
          WIP limit: <span class="fw-semibold"><%= @wip_limit %></span>
          <% if my_assignee.present? %>
            Â· <span class="text-muted">for <%= my_assignee %></span>
          <% end %>
        </div>
        <div>
          <% badge_class = @wip_count > @wip_limit ? "danger" : "warning" %>
          <span class="badge text-bg-<%= badge_class %>">
            WIP: <%= @wip_count %>
          </span>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div class="small text-muted">
          Resolution streak
        </div>
        <div>
          <% if resolution_streak_count.positive? %>
            <span class="badge text-bg-success">
              <%= resolution_streak_count %> day<%= "s" if resolution_streak_count != 1 %>
            </span>
            <span class="text-muted small ms-2">
              last: <%= resolution_streak_date %>
            </span>
          <% else %>
            <span class="badge text-bg-secondary">No streak yet</span>
          <% end %>
        </div>
      </div>

      <%= form_with url: tickets_path(view: tickets_view), method: :get, scope: :filters,
            data: { turbo_frame: "tickets_view" }, class: "row g-2 align-items-end" do |f| %>
        <div class="col-12 col-md-4">
          <%= f.label :q, "Search", class: "form-label" %>
          <%= f.text_field :q, value: filters["q"], class: "form-control", placeholder: "Title or description" %>
        </div>
        <div class="col-6 col-md-2">
          <%= f.label :status, class: "form-label" %>
          <%= f.select :status, options_for_select([["Any", ""], *Ticket::STATUSES], filters["status"]),
                {}, class: "form-select" %>
        </div>
        <div class="col-6 col-md-2">
          <%= f.label :priority, class: "form-label" %>
          <%= f.select :priority, options_for_select([["Any", ""], *Ticket::PRIORITIES], filters["priority"]),
                {}, class: "form-select" %>
        </div>
        <div class="col-12 col-md-2">
          <%= f.label :assignee, class: "form-label" %>
          <%= f.text_field :assignee, value: filters["assignee"], class: "form-control", placeholder: "Assignee" %>
        </div>
        <div class="col-12 col-md-2 d-flex gap-2">
          <%= f.submit "Apply", class: "btn btn-primary flex-grow-1" %>
        </div>
      <% end %>

      <div class="small text-muted mt-3">
        Manage personal preferences in your profile.
      </div>
    </div>
  </div>

  <%= render view, highlight_id: highlight_id %>

  <% if view == "board" && @board_has_more %>
    <div class="mt-3 text-center">
      <%= link_to "Show next 10", tickets_path(base_params.merge(view: "board", limit: @board_limit + 10)),
            class: "btn btn-outline-secondary",
            data: { turbo_frame: "tickets_view" } %>
      <div class="text-muted small mt-2">
        Showing <%= @board_limit %> of <%= @board_total %>
      </div>
    </div>
  <% elsif @pagy&.pages.to_i > 1 %>
    <div class="mt-3">
      <%== @pagy.series_nav(:bootstrap, link_extra: 'data-turbo-frame="tickets_view"') %>
    </div>
  <% end %>
<% end %>
